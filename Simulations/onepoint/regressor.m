%%-----------------------------------------------------------------------%%
% Description: regressor.m                                                %
%   Compute the regressor Y                                               %
%     -{ [A(t)_est' - A(t)'] + 1/2 * [a(t)_est - a(t)] * delta_y(t)' } * delta_y(t) % 
%     = Y * point_estimation_error                                        %
%                                                                         %
%   Input:  delta       2x1 image error                                   %
%           M           3x4 camera perspective projection matrix          %
%           T           4x4 endeffecter (frame) current homogenous        %
%                       transform matrix with respect to base frame       %
%           Y           current position(coordinates) of the feature      %
%                       point on the image plane                          %
%   Output: m           6x3 regressor                                     %
%                                                                         %
% Copyright:   Shanghai SJTU Autonomous Robot Lab.                        %
% Author:      Jay Wang                                                   %
% Version:     Beta 1.0.1                                                 %
% Data:        2015.04.09                                                 %
%%-----------------------------------------------------------------------%%

%%
function Y = regressor(deta,M,T,Y)
m1=M(1,1);m2=M(1,2);m3=M(1,3);m4=M(1,4);m5=M(2,1);m6=M(2,2);m7=M(2,3);m8=M(2,4);m9=M(3,1);m10=M(3,2);m11=M(3,3);m12=M(3,4);
r1=T(1,1);r2=T(1,2);r3=T(1,3);r4=T(2,1);r5=T(2,2);r6=T(2,3);r7=T(3,1);r8=T(3,2);r9=T(3,3);
tx=T(1,4);ty=T(2,4);tz=T(3,4);
u=Y(1);v=Y(2);
d1=deta(1);d2=deta(2);
Y = [                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                     0;
                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                     0;
                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                     0;
 ((r4*(m11*r1 - m9*r7))/2 - (r7*(m10*r1 - m9*r4))/2 - (r1*(m11*r4 - m10*r7))/2)*d1^2 + (r4*(r1*(m3 - m11*u) - r7*(m1 - m9*u)) - r7*(r1*(m2 - m10*u) - r4*(m1 - m9*u)) - r1*(r4*(m3 - m11*u) - r7*(m2 - m10*u)))*d1 + ((r4*(m11*r1 - m9*r7))/2 - (r7*(m10*r1 - m9*r4))/2 - (r1*(m11*r4 - m10*r7))/2)*d2^2 + (r4*(r1*(m7 - m11*v) - r7*(m5 - m9*v)) - r7*(r1*(m6 - m10*v) - r4*(m5 - m9*v)) - r1*(r4*(m7 - m11*v) - r7*(m6 - m10*v)))*d2, ((r4*(m11*r2 - m9*r8))/2 - (r7*(m10*r2 - m9*r5))/2 - (r1*(m11*r5 - m10*r8))/2)*d1^2 + (r4*(r2*(m3 - m11*u) - r8*(m1 - m9*u)) - r7*(r2*(m2 - m10*u) - r5*(m1 - m9*u)) - r1*(r5*(m3 - m11*u) - r8*(m2 - m10*u)))*d1 + ((r4*(m11*r2 - m9*r8))/2 - (r7*(m10*r2 - m9*r5))/2 - (r1*(m11*r5 - m10*r8))/2)*d2^2 + (r4*(r2*(m7 - m11*v) - r8*(m5 - m9*v)) - r7*(r2*(m6 - m10*v) - r5*(m5 - m9*v)) - r1*(r5*(m7 - m11*v) - r8*(m6 - m10*v)))*d2, ((r4*(m11*r3 - m9*r9))/2 - (r7*(m10*r3 - m9*r6))/2 - (r1*(m11*r6 - m10*r9))/2)*d1^2 + (r4*(r3*(m3 - m11*u) - r9*(m1 - m9*u)) - r7*(r3*(m2 - m10*u) - r6*(m1 - m9*u)) - r1*(r6*(m3 - m11*u) - r9*(m2 - m10*u)))*d1 + ((r4*(m11*r3 - m9*r9))/2 - (r7*(m10*r3 - m9*r6))/2 - (r1*(m11*r6 - m10*r9))/2)*d2^2 + (r4*(r3*(m7 - m11*v) - r9*(m5 - m9*v)) - r7*(r3*(m6 - m10*v) - r6*(m5 - m9*v)) - r1*(r6*(m7 - m11*v) - r9*(m6 - m10*v)))*d2;
 ((r5*(m11*r1 - m9*r7))/2 - (r8*(m10*r1 - m9*r4))/2 - (r2*(m11*r4 - m10*r7))/2)*d1^2 + (r5*(r1*(m3 - m11*u) - r7*(m1 - m9*u)) - r8*(r1*(m2 - m10*u) - r4*(m1 - m9*u)) - r2*(r4*(m3 - m11*u) - r7*(m2 - m10*u)))*d1 + ((r5*(m11*r1 - m9*r7))/2 - (r8*(m10*r1 - m9*r4))/2 - (r2*(m11*r4 - m10*r7))/2)*d2^2 + (r5*(r1*(m7 - m11*v) - r7*(m5 - m9*v)) - r8*(r1*(m6 - m10*v) - r4*(m5 - m9*v)) - r2*(r4*(m7 - m11*v) - r7*(m6 - m10*v)))*d2, ((r5*(m11*r2 - m9*r8))/2 - (r8*(m10*r2 - m9*r5))/2 - (r2*(m11*r5 - m10*r8))/2)*d1^2 + (r5*(r2*(m3 - m11*u) - r8*(m1 - m9*u)) - r8*(r2*(m2 - m10*u) - r5*(m1 - m9*u)) - r2*(r5*(m3 - m11*u) - r8*(m2 - m10*u)))*d1 + ((r5*(m11*r2 - m9*r8))/2 - (r8*(m10*r2 - m9*r5))/2 - (r2*(m11*r5 - m10*r8))/2)*d2^2 + (r5*(r2*(m7 - m11*v) - r8*(m5 - m9*v)) - r8*(r2*(m6 - m10*v) - r5*(m5 - m9*v)) - r2*(r5*(m7 - m11*v) - r8*(m6 - m10*v)))*d2, ((r5*(m11*r3 - m9*r9))/2 - (r8*(m10*r3 - m9*r6))/2 - (r2*(m11*r6 - m10*r9))/2)*d1^2 + (r5*(r3*(m3 - m11*u) - r9*(m1 - m9*u)) - r8*(r3*(m2 - m10*u) - r6*(m1 - m9*u)) - r2*(r6*(m3 - m11*u) - r9*(m2 - m10*u)))*d1 + ((r5*(m11*r3 - m9*r9))/2 - (r8*(m10*r3 - m9*r6))/2 - (r2*(m11*r6 - m10*r9))/2)*d2^2 + (r5*(r3*(m7 - m11*v) - r9*(m5 - m9*v)) - r8*(r3*(m6 - m10*v) - r6*(m5 - m9*v)) - r2*(r6*(m7 - m11*v) - r9*(m6 - m10*v)))*d2;
 ((r6*(m11*r1 - m9*r7))/2 - (r9*(m10*r1 - m9*r4))/2 - (r3*(m11*r4 - m10*r7))/2)*d1^2 + (r6*(r1*(m3 - m11*u) - r7*(m1 - m9*u)) - r9*(r1*(m2 - m10*u) - r4*(m1 - m9*u)) - r3*(r4*(m3 - m11*u) - r7*(m2 - m10*u)))*d1 + ((r6*(m11*r1 - m9*r7))/2 - (r9*(m10*r1 - m9*r4))/2 - (r3*(m11*r4 - m10*r7))/2)*d2^2 + (r6*(r1*(m7 - m11*v) - r7*(m5 - m9*v)) - r9*(r1*(m6 - m10*v) - r4*(m5 - m9*v)) - r3*(r4*(m7 - m11*v) - r7*(m6 - m10*v)))*d2, ((r6*(m11*r2 - m9*r8))/2 - (r9*(m10*r2 - m9*r5))/2 - (r3*(m11*r5 - m10*r8))/2)*d1^2 + (r6*(r2*(m3 - m11*u) - r8*(m1 - m9*u)) - r9*(r2*(m2 - m10*u) - r5*(m1 - m9*u)) - r3*(r5*(m3 - m11*u) - r8*(m2 - m10*u)))*d1 + ((r6*(m11*r2 - m9*r8))/2 - (r9*(m10*r2 - m9*r5))/2 - (r3*(m11*r5 - m10*r8))/2)*d2^2 + (r6*(r2*(m7 - m11*v) - r8*(m5 - m9*v)) - r9*(r2*(m6 - m10*v) - r5*(m5 - m9*v)) - r3*(r5*(m7 - m11*v) - r8*(m6 - m10*v)))*d2, ((r6*(m11*r3 - m9*r9))/2 - (r9*(m10*r3 - m9*r6))/2 - (r3*(m11*r6 - m10*r9))/2)*d1^2 + (r6*(r3*(m3 - m11*u) - r9*(m1 - m9*u)) - r9*(r3*(m2 - m10*u) - r6*(m1 - m9*u)) - r3*(r6*(m3 - m11*u) - r9*(m2 - m10*u)))*d1 + ((r6*(m11*r3 - m9*r9))/2 - (r9*(m10*r3 - m9*r6))/2 - (r3*(m11*r6 - m10*r9))/2)*d2^2 + (r6*(r3*(m7 - m11*v) - r9*(m5 - m9*v)) - r9*(r3*(m6 - m10*v) - r6*(m5 - m9*v)) - r3*(r6*(m7 - m11*v) - r9*(m6 - m10*v)))*d2];
 